#!/bin/bash
# بکاپ از دیتابیس‌های همه سرویس‌ها

BACKUP_DIR="{{ backup_path }}/{{ inventory_hostname }}/$(date +'%Y-%m-%d-%H-%M-%S')"
mkdir -p "$BACKUP_DIR"
chmod 777 "$BACKUP_DIR"

LOG="{{ log_path }}/backup/{{ inventory_hostname }}_databases.log"
echo "$(date '+%Y-%m-%d %H:%M:%S') | START database backup" >> "$LOG"

DB_FILE="{{ info_path }}/databases/{{ inventory_hostname }}.txt"

# چک کن فایل وجود داره
[[ ! -f "$DB_FILE" ]] && {
  echo "$(date '+%Y-%m-%d %H:%M:%S') | ERROR: $DB_FILE not found!" >> "$LOG"
  exit 1
}

while IFS=',' read -r type name user pass container || [[ -n "$name" ]]; do
  # رد کردن خطوط خالی یا کامنت
  [[ -z "$name" || "$name" == "#"* || "$name" == "mysql" ]] && continue

  file="${name}_$(date +%Y%m%d_%H%M%S).sql.gz"

  echo "$(date '+%Y-%m-%d %H:%M:%S') | DUMPING: $name ($container)" >> "$LOG"

  if docker exec "$container" mysqldump -u"$user" -p"$pass" --single-transaction --quick --lock-tables=false "$name" 2>>"$LOG" | gzip > "$BACKUP_DIR/$file"; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') | SUCCESS $name → $file" >> "$LOG"
  else
    echo "$(date '+%Y-%m-%d %H:%M:%S') | FAILED $name (container: $container)" >> "$LOG"
  fi
done < "$DB_FILE"

# پاک کردن بکاپ‌های قدیمی
KEEP={{ customer_backup_keep | default(7) }}
find "{{ backup_path }}/{{ inventory_hostname }}" -maxdepth 1 -type d -name "202*" -printf '%T@ %p\n' | sort -nr | tail -n +$((KEEP + 1)) | cut -d' ' -f2- | xargs rm -rf

echo "$(date '+%Y-%m-%d %H:%M:%S') | FINISH database backup | $(ls -1 "$BACKUP_DIR"/*.sql.gz 2>/dev/null | wc -l) databases" >> "$LOG"