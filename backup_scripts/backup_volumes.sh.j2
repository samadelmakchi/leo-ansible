#!/bin/bash
# بکاپ از فولدرهای مهم پروژه (آپلودها، لاگ، .env و ...)

BACKUP_DIR="{{ backup_path }}/{{ inventory_hostname }}/$(date +'%Y-%m-%d-%H-%M-%S')"
mkdir -p "$BACKUP_DIR"
chmod 777 "$BACKUP_DIR"

LOG="{{ log_path }}/backup/{{ inventory_hostname }}_volumes.log"
echo "$(date '+%Y-%m-%d %H:%M:%S') | START volume backup" >> "$LOG"

BASE="{{ project_path }}/{{ inventory_hostname }}"

# لیست تمام پوشه‌ها و فایل‌هایی که باید بکاپ بشن
VOLUMES=(
  # Gateway (CodeIgniter)
  "gateway/admin/uploads"
  "gateway/admin/captcha_images"
  "gateway/admin"

  # Portal + Frontend
  "portal"
  "portal-frontend"

  # LMS (Laravel)
  "lms/storage/app/public"
  "lms/storage/app/private"
  "lms/storage/logs"
  "lms/.env"

  # File Storage (Laravel)
  "file/storage/app/public"
  "file/storage/app/private"
  "file/storage/logs"
  "file/.env"

  # اگر بعداً public/uploads داشتی (پروژه‌های قدیمی)
  # "lms/public/uploads"
  # "file/public/uploads"
)

for dir in "${VOLUMES[@]}"; do
  full_path="$BASE/$dir"

  # اگر مسیر وجود نداشت، رد شو
  [[ ! -e "$full_path" ]] && continue

  # اسم آرشیو: جایگزینی / با _ (مثلاً lms_storage_app_public)
  archive_name="$(echo "$dir" | tr '/' '_').tar.gz"

  echo "$(date '+%Y-%m-%d %H:%M:%S') | BACKING UP: $dir → $archive_name" >> "$LOG"

  if tar -czf "$BACKUP_DIR/$archive_name" -C "$(dirname "$full_path")" "$(basename "$full_path")" >> "$LOG" 2>&1; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') | SUCCESS $dir" >> "$LOG"
  else
    echo "$(date '+%Y-%m-%d %H:%M:%S') | FAILED $dir" >> "$LOG"
  fi
done

# پاک کردن بکاپ‌های قدیمی (فقط KEEP تا آخر نگه دار)
KEEP={{ customer_backup_keep | default(7) }}
find "{{ backup_path }}/{{ inventory_hostname }}" -maxdepth 1 -type d -name "202*" -printf '%T@ %p\n' | sort -nr | tail -n +$((KEEP + 1)) | cut -d' ' -f2- | xargs rm -rf

echo "$(date '+%Y-%m-%d %H:%M:%S') | FINISH volume backup | $(ls -1 "$BACKUP_DIR" | wc -l) files" >> "$LOG"