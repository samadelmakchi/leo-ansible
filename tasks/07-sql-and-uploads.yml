# tasks/07-sql-and-uploads.yml ← نسخه نهایی بدون نیاز به default_portal.sql
---
- name: Restore SQL + Uploads + .env for all services (only if files exist)
  when: customer_state == "up"
  block:

    # ===================================================================
    # ۱. Gateway (CodeIgniter)
    # ===================================================================
    - name: "[Gateway] Restore SQL (فقط اگر فایل مشتری یا پیش‌فرض باشه)"
      ansible.builtin.copy:
        src: "{{ 'sql/' + inventory_hostname + '_gateway.sql' if lookup('fileglob', 'sql/*_gateway.sql', errors='ignore') | length > 0 else 'sql/default_gateway.sql' }}"
        dest: "{{ project_path }}/{{ inventory_hostname }}/gateway/docker/init/install.sql"
        mode: "0644"
      ignore_errors: true

    - name: "[Gateway] Restore uploads"
      ansible.builtin.unarchive:
        src: "sql/{{ inventory_hostname }}_gateway_uploads.zip"
        dest: "{{ project_path }}/{{ inventory_hostname }}/gateway/admin/uploads"
        creates: "{{ project_path }}/{{ inventory_hostname }}/gateway/admin/uploads/index.html"
      ignore_errors: true


    # ===================================================================
    # ۲. Portal (Symfony) — فقط اگه فایل مشتری باشه
    # ===================================================================
    - name: "[Portal] Restore SQL (فقط اگر فایل مشتری باشه — بدون default!)"
      ansible.builtin.copy:
        src: "sql/{{ inventory_hostname }}_portal.sql"
        dest: "{{ project_path }}/{{ inventory_hostname }}/portal/docker/init/install.sql"
        mode: "0644"
      ignore_errors: true   # اگه فایل نباشه → خطا نده → میگریشن خودش می‌سازه

    - name: "[Portal] Restore uploads"
      ansible.builtin.unarchive:
        src: "sql/{{ inventory_hostname }}_portal_uploads.zip"
        dest: "{{ project_path }}/{{ inventory_hostname }}/portal/public/uploads"
        creates: "{{ project_path }}/{{ inventory_hostname }}/portal/public/uploads/.gitkeep"
      ignore_errors: true


    # ===================================================================
    # ۳. Portal-Frontend — فقط اگه فایل وجود داشته باشه
    # ===================================================================
    - name: "[Frontend] Restore static files"
      ansible.builtin.unarchive:
        src: "sql/{{ inventory_hostname }}_frontend.zip"
        dest: "{{ project_path }}/{{ inventory_hostname }}/portal-frontend"
        exclude:
          - node_modules
          - .git
      ignore_errors: true


    # ===================================================================
    # ۴. LMS (Laravel)
    # ===================================================================
    - name: "[LMS] Restore SQL"
      ansible.builtin.copy:
        src: "sql/{{ inventory_hostname }}_lms.sql"
        dest: "{{ project_path }}/{{ inventory_hostname }}/lms/docker/init/install.sql"
        mode: "0644"
      ignore_errors: true

    - name: "[LMS] Restore uploads"
      ansible.builtin.unarchive:
        src: "sql/{{ inventory_hostname }}_lms_uploads.zip"
        dest: "{{ project_path }}/{{ inventory_hostname }}/lms/storage/app"
      ignore_errors: true

    - name: "[LMS] Restore .env"
      ansible.builtin.copy:
        src: "sql/{{ inventory_hostname }}_lms.env"
        dest: "{{ project_path }}/{{ inventory_hostname }}/lms/.env"
        mode: "0600"
      ignore_errors: true


    # ===================================================================
    # ۵. File (Laravel)
    # ===================================================================
    - name: "[File] Restore SQL"
      ansible.builtin.copy:
        src: "sql/{{ inventory_hostname }}_file.sql"
        dest: "{{ project_path }}/{{ inventory_hostname }}/file/docker/init/install.sql"
        mode: "0644"
      ignore_errors: true

    - name: "[File] Restore uploads"
      ansible.builtin.unarchive:
        src: "sql/{{ inventory_hostname }}_file_uploads.zip"
        dest: "{{ project_path }}/{{ inventory_hostname }}/file/storage/app"
      ignore_errors: true

    - name: "[File] Restore .env"
      ansible.builtin.copy:
        src: "sql/{{ inventory_hostname }}_file.env"
        dest: "{{ project_path }}/{{ inventory_hostname }}/file/.env"
        mode: "0600"
      ignore_errors: true