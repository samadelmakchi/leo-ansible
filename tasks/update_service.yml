---
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
- name: Set project variable
  set_fact:
    project: "{{ current_project | default(item) }}"
  tags: always

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
- name: Check if repo directory has valid .git
  ansible.builtin.stat:
    path: "{{ project_path }}/{{ inventory_hostname }}/{{ project.folder }}/.git"
  register: git_dir
  changed_when: false

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
- name: Remove broken/incomplete repo
  ansible.builtin.file:
    path: "{{ project_path }}/{{ inventory_hostname }}/{{ project.folder }}"
    state: absent
  when: not git_dir.stat.exists

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
- name: Ensure parent directory exists before clone
  ansible.builtin.file:
    path: "{{ project_path }}/{{ inventory_hostname }}/{{ project.folder }}"
    state: directory
    mode: "0755"
  when: not git_dir.stat.exists

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
- name: Clone or force-update repo to desired version
  ansible.builtin.git:
    repo: "{{ project.repo }}"
    dest: "{{ project_path }}/{{ inventory_hostname }}/{{ project.folder }}"
    version: >-
      {% if hostvars[inventory_hostname][project.tag_var] | default('') | trim | length > 0 %}
        {{ hostvars[inventory_hostname][project.tag_var] | trim }}
      {% elif hostvars[inventory_hostname][project.branch_var] | default('') | trim | length > 0 %}
        {{ hostvars[inventory_hostname][project.branch_var] | trim }}
      {% else %}
        main
      {% endif %}
    key_file: "{{ playbook_dir }}/id_rsa"
    accept_hostkey: yes
    update: yes
    force: yes
  register: git_result
  changed_when: git_result.after is defined and git_result.before is defined and git_result.after != git_result.before

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
- name: Show git update summary
  debug:
    msg: >-
      Project {{ project.name }}:
      {{ git_result.before[:7] if git_result.before is defined and git_result.before else 'none' }}
      â†’
      {{ git_result.after[:7] if git_result.after is defined and git_result.after else 'cloned' }}
      {% if git_result.after is not defined or not git_result.after %}(New Clone){% endif %}
  when: git_result is defined

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
- name: Ensure docker directory exists
  ansible.builtin.file:
    path: "{{ project_path }}/{{ inventory_hostname }}/{{ project.folder }}/docker"
    state: directory
    mode: "0755"

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
- name: Ensure gateway docker/init directory exists
  ansible.builtin.file:
    path: "{{ project_path }}/{{ inventory_hostname }}/{{ project.folder }}/docker/init"
    state: directory
    mode: "0755"
  when: project.name == "gateway"

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
- name: Deploy docker-compose.yml
  ansible.builtin.template:
    src: >-
      {% if project.folder == "portal-frontend" -%}
      ../template/compose-portal-frontend.yml.j2
      {%- else -%}
      ../template/compose-{{ project.folder }}.yml.j2
      {%- endif %}
    dest: "{{ project_path }}/{{ inventory_hostname }}/{{ project.folder }}/docker/docker-compose.yml"
    mode: "0644"
    backup: yes
    force: yes

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
- name: Check if override file already exists
  ansible.builtin.stat:
    path: "{{ project_path }}/{{ inventory_hostname }}/{{ project.folder }}/docker/"
  register: override_stat
  changed_when: false

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
- name: Deploy docker-compose.yml
  ansible.builtin.template:
    src: >-
      {% if project.folder == "portal-frontend" %}../template/compose-portal-frontend.yml.j2{% else %}../template/compose-{{ project.folder }}.yml.j2{% endif %}
    dest: "{{ project_path }}/{{ inventory_hostname }}/{{ project.folder }}/docker/docker-compose.yml"
    mode: "0644"
    backup: yes
    force: yes
  when: not override_stat.stat.exists