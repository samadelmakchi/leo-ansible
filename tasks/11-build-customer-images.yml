---
- name: Build customer-specific images only when needed (idempotent + fast)
  ansible.builtin.command: >
    docker compose
    -f docker-compose.yml
    build
    --pull
    {{ '--no-cache' if force_rebuild | default(false) else '' }}
  args:
    chdir: "{{ project_path }}/{{ inventory_hostname }}/{{ project_item.folder }}/docker"
  register: docker_build
  changed_when: "'Building' in docker_build.stdout or 'Built' in docker_build.stdout"
  become: true
  loop: "{{ projects }}"
  loop_control:
    loop_var: project_item
    label: "{{ project_item.name }}"
  tags: [deploy, force_deploy]