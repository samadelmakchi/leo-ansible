---
- name: Run migrations only if code was updated
  when:
    - customer_state == "up"
    - any_service_updated | default(false) | bool
  block:

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    - name: Ensure containers are up (compose)
      community.docker.docker_compose:
        project_src: "{{ project_path }}/{{ inventory_hostname }}/{{ project.folder }}/docker"
        files:
          - docker-compose.yml
        state: present
      loop: "{{ projects }}"
      loop_control:
        loop_var: project
      when: project.update | default(false) | bool
      register: _compose
      retries: 5
      delay: 10
      until: _compose is succeeded

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # Portal (Symfony)
    - name: Get portal container IDs
      command: docker ps --filter "name={{ customer_containers }}-portal" --format "{{ '{{.Names}}' }}"
      register: portal_containers
      changed_when: false
      when: customer_portal_update | default(false) | bool

    - name: Composer install (portal)
      community.docker.docker_container_exec:
        container: "{{ item }}"
        command: composer install --no-dev --optimize-autoloader --no-interaction
      loop: "{{ portal_containers.stdout_lines }}"
      async: 300
      poll: 10
      ignore_errors: true
      when: customer_portal_update | default(false) | bool

    - name: Doctrine migrations (portal)
      community.docker.docker_container_exec:
        container: "{{ item }}"
        command: php bin/console doctrine:migrations:migrate --no-interaction --env=prod
      loop: "{{ portal_containers.stdout_lines }}"
      async: 300
      poll: 10
      ignore_errors: true
      when: customer_portal_update | default(false) | bool

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # Gateway (CodeIgniter)
    - name: Get gateway container IDs
      command: docker ps --filter "name={{ customer_containers }}-gateway" --format "{{ '{{.Names}}' }}"
      register: gateway_containers
      changed_when: false
      when: customer_gateway_update | default(false) | bool

    - name: Gateway migration
      community.docker.docker_container_exec:
        container: "{{ item }}"
        command: php index.php migrate index false
      loop: "{{ gateway_containers.stdout_lines }}"
      async: 300
      poll: 10
      ignore_errors: true
      when: customer_gateway_update | default(false) | bool

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # LMS (Laravel)
    - name: Get lms container IDs
      command: docker ps --filter "name={{ customer_containers }}-lms" --format "{{ '{{.Names}}' }}"
      register: lms_containers
      changed_when: false
      when: customer_lms_update | default(false) | bool

    - name: Composer install (lms)
      community.docker.docker_container_exec:
        container: "{{ item }}"
        command: composer install --no-dev --optimize-autoloader --no-interaction
      loop: "{{ lms_containers.stdout_lines }}"
      async: 300
      poll: 10
      ignore_errors: true
      when: customer_lms_update | default(false) | bool

    - name: Laravel cache clear + config cache (lms)
      community.docker.docker_container_exec:
        container: "{{ item }}"
        command: >
          php artisan config:clear &&
          php artisan config:cache &&
          php artisan route:cache &&
          php artisan view:cache
      loop: "{{ lms_containers.stdout_lines }}"
      async: 300
      poll: 10
      ignore_errors: true
      when: customer_lms_update | default(false) | bool

    - name: Laravel migrate (lms)
      community.docker.docker_container_exec:
        container: "{{ item }}"
        command: php artisan migrate --force
      loop: "{{ lms_containers.stdout_lines }}"
      async: 300
      poll: 10
      ignore_errors: true
      when: customer_lms_update | default(false) | bool

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # File Storage (Laravel)
    - name: Get file container IDs
      command: docker ps --filter "name={{ customer_containers }}-file" --format "{{ '{{.Names}}' }}"
      register: file_containers
      changed_when: false
      when: customer_file_update | default(false) | bool

    - name: Composer install (file)
      community.docker.docker_container_exec:
        container: "{{ item }}"
        command: composer install --no-dev --optimize-autoloader --no-interaction
      loop: "{{ file_containers.stdout_lines }}"
      async: 300
      poll: 10
      ignore_errors: true
      when: customer_file_update | default(false) | bool

    - name: Laravel cache clear + config cache (file)
      community.docker.docker_container_exec:
        container: "{{ item }}"
        command: >
          php artisan config:clear &&
          php artisan config:cache &&
          php artisan route:cache &&
          php artisan view:cache
      loop: "{{ file_containers.stdout_lines }}"
      async: 300
      poll: 10
      ignore_errors: true
      when: customer_file_update | default(false) | bool

    - name: Laravel migrate (file)
      community.docker.docker_container_exec:
        container: "{{ item }}"
        command: php artisan migrate --force
      loop: "{{ file_containers.stdout_lines }}"
      async: 300
      poll: 10
      ignore_errors: true
      when: customer_file_update | default(false) | bool
